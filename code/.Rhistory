combined_figure <- (plots[[1]] | plots[[2]] | plots[[3]]) /
(plots[[4]] | plots[[5]] | plots[[6]]) /
(plots[[7]] | plots[[8]] | plots[[9]])
combined_figure
here::i_am("code/final_make_figures.R")
# Load libraries
library(ggplot2)
library(dplyr)
library(patchwork)
# load data
dat <- fread(here::here("data/breast-cancer.data"))
# add column names
colnames(dat) <- c("class", "age", "menopause", "tumor_size",
"inv_nodes", "node_caps", "deg_malig", "breast",
"breast_quad", "irradiat")
# Function to make a stacked bar plot for categorical vars
make_plot <- function(var) {
ggplot(dat, aes_string(x = var, fill = "class")) +
geom_bar(position = "fill") +
labs(
title = paste("Recurrence by", var),
x = var, y = "Proportion"
) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
# Variables to plot (all except outcome)
vars <- c("age", "menopause", "tumor_size", "inv_nodes", "node_caps",
"deg_malig", "breast", "breast_quad", "irradiat")
# Generate list of plots
plots <- lapply(vars, make_plot)
# Combine into grid (3 rows x 3 columns)
combined_figure <- (plots[[1]] | plots[[2]] | plots[[3]]) /
(plots[[4]] | plots[[5]] | plots[[6]]) /
(plots[[7]] | plots[[8]] | plots[[9]])
saveRDS(
combined_figure,
file=here::here("figures/combined_figure.rds")
)
here::i_am("code/final_make_figures.R")
# Load libraries
library(ggplot2)
library(dplyr)
library(patchwork)
# load data
dat <- fread(here::here("data/breast-cancer.data"))
# add column names
colnames(dat) <- c("class", "age", "menopause", "tumor_size",
"inv_nodes", "node_caps", "deg_malig", "breast",
"breast_quad", "irradiat")
# Function to make a stacked bar plot for categorical vars
make_plot <- function(var) {
ggplot(dat, aes_string(x = var, fill = "class")) +
geom_bar(position = "fill") +
labs(
title = paste("Recurrence by", var),
x = var, y = "Proportion"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none"   # suppress legend inside each plot
)
}
# Variables to plot (all except outcome)
vars <- c("age", "menopause", "tumor_size", "inv_nodes", "node_caps",
"deg_malig", "breast", "breast_quad", "irradiat")
# Generate list of plots
plots <- lapply(vars, make_plot)
# Combine into grid (3 rows x 3 columns)
combined_figure <- (plots[[1]] | plots[[2]] | plots[[3]]) /
(plots[[4]] | plots[[5]] | plots[[6]]) /
(plots[[7]] | plots[[8]] | plots[[9]])
saveRDS(
combined_figure,
file=here::here("figures/combined_figure.rds")
)
combined_figure
here::i_am("code/final_make_figures.R")
# Load libraries
library(ggplot2)
library(dplyr)
library(patchwork)
# load data
dat <- fread(here::here("data/breast-cancer.data"))
# add column names
colnames(dat) <- c("class", "age", "menopause", "tumor_size",
"inv_nodes", "node_caps", "deg_malig", "breast",
"breast_quad", "irradiat")
# Function to make a stacked bar plot for categorical vars
make_plot <- function(var) {
ggplot(dat, aes_string(x = var, fill = "class")) +
geom_bar(position = "fill") +
labs(
title = paste("Recurrence by", var),
x = var, y = "Proportion"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.key.size = unit(0.4, "cm"),     # smaller legend boxes
legend.text = element_text(size = 8),  # smaller legend text
legend.title = element_text(size = 9)  # smaller legend title
)
}
# Variables to plot (all except outcome)
vars <- c("age", "menopause", "tumor_size", "inv_nodes", "node_caps",
"deg_malig", "breast", "breast_quad", "irradiat")
# Generate list of plots
plots <- lapply(vars, make_plot)
# Combine into grid (3 rows x 3 columns)
combined_figure <- (plots[[1]] | plots[[2]] | plots[[3]]) /
(plots[[4]] | plots[[5]] | plots[[6]]) /
(plots[[7]] | plots[[8]] | plots[[9]])
saveRDS(
combined_figure,
file=here::here("figures/combined_figure.rds")
)
combined_figure
make_plot <- function(var) {
ggplot(dat, aes_string(x = var, fill = "class")) +
geom_bar(position = "fill") +
labs(
title = paste("Recurrence by", var),
x = var, y = "Proportion"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none"  # suppress legends in individual plots
)
}
# Variables
vars <- c("age", "menopause", "tumor_size", "inv_nodes", "node_caps",
"deg_malig", "breast", "breast_quad", "irradiat")
# Make plots
plots <- lapply(vars, make_plot)
# Combine into 3x3 grid
combined <- (plots[[1]] | plots[[2]] | plots[[3]]) /
(plots[[4]] | plots[[5]] | plots[[6]]) /
(plots[[7]] | plots[[8]] | plots[[9]])
# Extract one legend from a representative plot
legend_plot <- ggplot(dat, aes(x = factor(deg_malig), fill = class)) +
geom_bar(position = "fill") +
theme_minimal() +
theme(
legend.position = "bottom",
legend.key.size = unit(0.4, "cm"),
legend.text = element_text(size = 8),
legend.title = element_text(size = 9)
) +
labs(fill = "Recurrence Status")
# Use patchwork to place legend below combined plots
final_plot <- combined / legend_plot + plot_layout(heights = c(3, 0.2))
final_plot
combined
# Extract one legend from a representative plot
legend_plot <- ggplot(dat, aes(x = factor(deg_malig), fill = class)) +
geom_bar(position = "fill") +
theme_minimal() +
theme(
legend.position = "bottom",
legend.key.size = unit(0.4, "cm"),
legend.text = element_text(size = 8),
legend.title = element_text(size = 9)
) +
labs(fill = "Recurrence Status")
legend_plot
final_plot
# Use patchwork to place legend below combined plots
final_plot <- combined / legend_plot + plot_layout(heights = c(3, 0.2))
combined / legend_plot + plot_layout(heights = c(3, 0.2))
make_plot <- function(var) {
ggplot(dat, aes_string(x = var, fill = "class")) +
geom_bar(position = "fill") +
labs(
title = paste("Recurrence by", var),
x = var, y = "Proportion"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none"
)
}
# Variables
vars <- c("age", "menopause", "tumor_size", "inv_nodes", "node_caps",
"deg_malig", "breast", "breast_quad", "irradiat")
# Generate plots
plots <- lapply(vars, make_plot)
# Combine into 3x3 grid
grid_plots <- wrap_plots(plots, nrow = 3, ncol = 3)
# Create a single legend
legend_plot <- ggplot(dat, aes(x = factor(deg_malig), fill = class)) +
geom_bar(position = "fill") +
theme_minimal() +
theme(
legend.position = "bottom",
legend.key.size = unit(0.4, "cm"),
legend.text = element_text(size = 8),
legend.title = element_text(size = 9)
) +
labs(fill = "Recurrence Status")
# Extract legend only
legend <- cowplot::get_legend(legend_plot)
# Combine grid + legend
final_plot <- cowplot::plot_grid(
grid_plots,
legend,
ncol = 1,
rel_heights = c(1, 0.05)  # grid taller, legend shorter
)
final_plot
here::i_am("code/final_make_figures.R")
# Load libraries
library(ggplot2)
library(dplyr)
library(patchwork)
# load data
dat <- fread(here::here("data/breast-cancer.data"))
# add column names
colnames(dat) <- c("class", "age", "menopause", "tumor_size",
"inv_nodes", "node_caps", "deg_malig", "breast",
"breast_quad", "irradiat")
# Function to make a stacked bar plot for categorical vars
make_plot <- function(var) {
ggplot(dat, aes_string(x = var, fill = "class")) +
geom_bar(position = "fill") +
labs(
title = paste("Recurrence by", var),
x = var, y = "Proportion"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none"
)
}
# Variables
vars <- c("age", "menopause", "tumor_size", "inv_nodes", "node_caps",
"deg_malig", "breast", "breast_quad", "irradiat")
# Generate plots
plots <- lapply(vars, make_plot)
# Combine into 3x3 grid
grid_plots <- wrap_plots(plots, nrow = 3, ncol = 3)
# Create a single legend
legend_plot <- ggplot(dat, aes(x = factor(deg_malig), fill = class)) +
geom_bar(position = "fill") +
theme_minimal() +
theme(
legend.position = "bottom",
legend.key.size = unit(0.4, "cm"),
legend.text = element_text(size = 8),
legend.title = element_text(size = 9)
) +
labs(fill = "Recurrence Status")
# Extract legend only
legend <- cowplot::get_legend(legend_plot)
# Combine grid + legend
combined_figure <- cowplot::plot_grid(
grid_plots,
legend,
ncol = 1,
rel_heights = c(1, 0.05)  # grid taller, legend shorter
)
saveRDS(
combined_figure,
file=here::here("figures/combined_figure.rds")
)
here::i_am("code/final_make_figures.R")
# Load libraries
library(ggplot2)
library(dplyr)
library(patchwork)
# load data
dat <- fread(here::here("data/breast-cancer.data"))
# add column names
colnames(dat) <- c("class", "age", "menopause", "tumor_size",
"inv_nodes", "node_caps", "deg_malig", "breast",
"breast_quad", "irradiat")
# Visualization
make_plot <- function(var) {
ggplot(dat, aes_string(x = var, fill = "class")) +
geom_bar(position = "fill") +
labs(
title = paste("Recurrence by", var),
x = var, y = "Proportion"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none"
)
}
vars <- c("age", "menopause", "tumor_size", "inv_nodes", "node_caps",
"deg_malig", "breast", "breast_quad", "irradiat")
plots <- lapply(vars, make_plot)
grid_plots <- wrap_plots(plots, nrow = 3, ncol = 3)
legend_plot <- ggplot(dat, aes(x = factor(deg_malig), fill = class)) +
geom_bar(position = "fill") +
theme_minimal() +
theme(
legend.position = "bottom",
legend.key.size = unit(0.4, "cm"),
legend.text = element_text(size = 8),
legend.title = element_text(size = 9)
) +
labs(fill = "Recurrence Status")
legend <- cowplot::get_legend(legend_plot)
combined_figure <- cowplot::plot_grid(
grid_plots,
legend,
ncol = 1,
rel_heights = c(1, 0.05)  # grid taller, legend shorter
)
saveRDS(
combined_figure,
file=here::here("figures/combined_figure.rds")
)
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(survival)
library(survminer)
library(risksetROC)
library(timeROC)
library(pec)
here::i_am("A14.Rmd")
file_loc <- here::here("20250921_IDH_mutant_astrocytomas_SPSS_to_KEC.xlsx")
dat <- read_xlsx(file_loc)
head(dat)
dat$`2021_WHO` <- as.factor(dat$`2021_WHO`)
dat$Entire_tumor_EOR <- as.factor(dat$Entire_tumor_EOR)
dat$RANO <- as.factor(dat$RANO)
str(dat)
# KPS, 2021_WHO (multicategorical variable), nonfrontal_0_frontal_1, GC_1, Total_tumor, Entire_tumor_EOR)
cox <- coxph(Surv(PFS_mo, Progression) ~ KPS + `2021_WHO` +
nonfrontal_0_frontal_1 + GC_1 + Total_tumor + Entire_tumor_EOR,
data = dat)
summary(cox)
# there are 3 variables that violate the ph assumption: KPS, 2021_WHO, Total_tumor
# we will find the interaction between variable & time + P value
tt.cox <- coxph(Surv(PFS_mo, Progression) ~ KPS + tt(KPS) +
nonfrontal_0_frontal_1 + GC_1 +
Total_tumor + tt(Total_tumor) +
Entire_tumor_EOR + strata(`2021_WHO`),
data = dat,
tt = function(x, t, ...) x * log(t))
summary(tt.cox)
# Piecewise Time-Dependent Cox (step function)
# Split dataset into intervals
td_dat <- survSplit(Surv(PFS_mo, Progression) ~ .,
data = dat,
cut = c(12, 36, 60),  # time points (months)
episode = "timegroup",
id = "id")
# Cox model: WHO effect can differ by time interval
cox_pw <- coxph(Surv(tstart, PFS_mo, Progression) ~
KPS +
`2021_WHO`:strata(timegroup) +
nonfrontal_0_frontal_1 +
GC_1 +
Total_tumor +
Entire_tumor_EOR,
data = td_dat)
summary(cox_pw)
# Piecewise Time-Dependent Cox (step function)
# Split dataset into intervals
td_dat <- survSplit(Surv(PFS_mo, Progression) ~ .,
data = dat,
# cut = c(12, 36, 60),  # time points (months)
episode = "timegroup",
id = "id")
？survSplit
?survSplit
# Cox model: WHO effect can differ by time interval
cox_pw <- coxph(Surv(tstart, PFS_mo, Progression) ~
KPS +
`2021_WHO`:strata(timegroup) +
nonfrontal_0_frontal_1 +
GC_1 +
Total_tumor +
Entire_tumor_EOR,
data = td_dat)
summary(cox_pw)
# Piecewise Time-Dependent Cox (step function)
# Split dataset into intervals
td_dat <- survSplit(Surv(PFS_mo, Progression) ~ .,
data = dat,
cut = c(12, 36, 60),  # time points (months)
episode = "timegroup",
id = "id")
# Cox model: WHO effect can differ by time interval
cox_pw <- coxph(Surv(tstart, PFS_mo, Progression) ~
KPS +
`2021_WHO`:strata(timegroup) +
nonfrontal_0_frontal_1 +
GC_1 +
Total_tumor +
Entire_tumor_EOR,
data = td_dat)
summary(cox_pw)
coxph(Surv(PFS_mo, Progression) ~ KPS + tt(KPS) +
nonfrontal_0_frontal_1 + GC_1 +
Total_tumor + tt(Total_tumor) +
Entire_tumor_EOR + `2021_WHO` * log(PFS_mo),
data = dat,
tt = function(x, t, ...) x * log(t))
coxph(Surv(PFS_mo, Progression) ~ KPS + tt(KPS) +
nonfrontal_0_frontal_1 + GC_1 +
Total_tumor + tt(Total_tumor) +
Entire_tumor_EOR + `2021_WHO` * PFS_mo,
data = dat,
tt = function(x, t, ...) x * log(t))
coxph(Surv(PFS_mo, Progression) ~ KPS + tt(KPS) +
nonfrontal_0_frontal_1 + GC_1 +
Total_tumor + tt(Total_tumor) +
Entire_tumor_EOR + `2021_WHO`,
data = dat,
tt = function(x, t, ...) x * log(t))
summary(cox)
# check ph assumption
sch.idh <- cox.zph(cox);
print(sch.idh)
here::i_am(
"code/final_render_report.R"
)
rmarkdown::render(
here::here("Final-Project.Rmd")
)
here::i_am("code/final_make_figures.R")
# Load libraries
library(ggplot2)
library(dplyr)
library(patchwork)
# load data
dat <- fread(here::here("data/breast-cancer.data"))
# add column names
colnames(dat) <- c("class", "age", "menopause", "tumor_size",
"inv_nodes", "node_caps", "deg_malig", "breast",
"breast_quad", "irradiat")
# Visualization
make_plot <- function(var) {
ggplot(dat, aes_string(x = var, fill = "class")) +
geom_bar(position = "fill") +
labs(
title = paste("Recurrence by", var),
x = var, y = "Proportion"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none"
)
}
vars <- c("age", "menopause", "tumor_size", "inv_nodes", "node_caps",
"deg_malig", "breast", "breast_quad", "irradiat")
plots <- lapply(vars, make_plot)
grid_plots <- wrap_plots(plots, nrow = 3, ncol = 3)
legend_plot <- ggplot(dat, aes(x = factor(deg_malig), fill = class)) +
geom_bar(position = "fill") +
theme_minimal() +
theme(
legend.position = "bottom",
legend.key.size = unit(0.4, "cm"),
legend.text = element_text(size = 8),
legend.title = element_text(size = 9)
) +
labs(fill = "Recurrence Status")
legend <- cowplot::get_legend(legend_plot)
combined_figure <- cowplot::plot_grid(
grid_plots,
legend,
ncol = 1,
rel_heights = c(1, 0.05)  # grid taller, legend shorter
)
saveRDS(
combined_figure,
file=here::here("figures/combined_figure.rds")
)
here::i_am("code/final_make_table1.R")
# load required packages
library(data.table)
library(gtsummary)
library(dplyr)
# load data
dat <- fread(here::here("data/breast-cancer.data"))
# add column names
colnames(dat) <- c("class", "age", "menopause", "tumor_size",
"inv_nodes", "node_caps", "deg_malig", "breast",
"breast_quad", "irradiat")
table_one <- dat %>%
dplyr::select(age, menopause, tumor_size, inv_nodes, node_caps,
deg_malig, breast, breast_quad, irradiat, class) %>%
tbl_summary(
by = class,  # stratify by recurrence status
statistic = list(
all_continuous() ~ "{mean} ({sd})",   # mean (SD) for continuous
all_categorical() ~ "{n} ({p}%)"      # count (percent) for categorical
),
missing = "no"  # missing values are ignored
) %>%
add_p(test = list(
all_continuous() ~ "oneway.test",  # ANOVA for continuous vars
all_categorical() ~ "chisq.test"   # Chi-sq for categorical vars
)) %>%
add_overall() %>%
bold_labels() %>%
bold_p()
saveRDS(
table_one,
file = here::here("tables/table_one.rds")
)
